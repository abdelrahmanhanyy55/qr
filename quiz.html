<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cybersecurity Quiz</title>
<style>
:root {
  --bg:#0f1724; --card:#0b1220; --accent:#00b4d8; --muted:#98a0b3; --success:#16a34a; --danger:#ef4444;
}
* { box-sizing:border-box; }
body { 
    margin:0; 
    font-family:Arial,sans-serif; 
    background:var(--bg); 
    color:#e6eef8; 
    display:flex; 
    justify-content:center; 
    align-items:center; 
    padding:24px; 
    min-height:100vh;
}
.container { 
    display:grid; 
    grid-template-columns:1fr 360px; 
    gap:16px; 
    width:100%; 
    max-width:920px; 
    background:var(--card); 
    border-radius:12px; 
    padding:18px; 
    box-shadow:0 10px 30px rgba(2,6,23,0.6); 
}
.quiz{padding:16px;}
h1{margin:0 0 8px 0;font-size:20px;}
.meta{color:var(--muted);font-size:13px;margin-bottom:12px;}
.card{background:rgba(255,255,255,0.02);border-radius:10px;padding:14px;margin-bottom:14px;}
.question{font-weight:600;margin-bottom:10px;}
.choices{display:flex;flex-direction:column;gap:8px;}
.choice{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));}
.choice:hover{transform:translateY(-2px);}
.choice.selected{outline:2px solid rgba(0,180,216,0.18);} 
.controls{display:flex;gap:8px;align-items:center;margin-top:12px;}
button{background:var(--accent);border:none;color:#042028;padding:10px 14px;border-radius:8px;font-weight:700;cursor:pointer;}
button[disabled]{opacity:0.45;cursor:not-allowed;}
.sidebar{padding:12px;display:flex;flex-direction:column;gap:12px;}
.stat{display:flex;justify-content:space-between;align-items:center;}
.timer{font-weight:800;font-size:20px;color:var(--accent);}
.progress{height:10px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden;}
.progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--accent), #6dd3ff);width:0%;}
.results{text-align:center;}
.small{font-size:13px;color:var(--muted);}
.footer-note{font-size:12px;color:var(--muted);margin-top:8px;}

/* Logo Positioning (Position Fixed for guaranteed placement) */
.logo {
    position: fixed; /* Positions relative to the viewport/window */
    top: 24px;       
    right: 24px;     
    width: 140px;     
    height: auto;
    z-index: 100;    
}

@media(max-width:940px){
    .container{grid-template-columns:1fr; padding:12px;}
    .sidebar{order:2}
    /* Adjust logo position/size for smaller screens */
    .logo {
        top: 12px;
        right: 12px;
        width: 45px;
    }
}
</style>
</head>
<body>
<img src="its.png" alt="ITS Logo" class="logo">

<div class="container">
  <div class="quiz card" id="quizArea">
    <h1>ITS Riddle Challenge</h1>
    <div class="meta">15 riddles • experienced users • time limit: 10 minutes</div>
    <div id="questionCard" class="card" aria-live="polite">
      <div class="question" id="qText">Loading…</div>
      <div class="choices" id="choices"></div>
      <div class="controls">
        <button id="nextBtn">Next</button>
        <div class="small" style="margin-left:8px">Question <span id="qIndex">0</span> / <span id="qTotal">0</span></div>
      </div>
    </div>
    <div id="endBlock" class="card" style="display:none">
      <div class="results" id="resultSummary"></div>
      <div style="margin-top:12px">
        </div>
    </div>
  </div>
  <aside class="sidebar card" aria-label="status panel">
    <div>
      <div class="stat"><div class="small">Time left</div><div class="timer" id="timeLeft">10:00</div></div>
      <div class="progress"><span id="timeProgress"></span></div>
    </div>
    
    <div>
      <div class="small">Question map</div>
      <div id="map" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px"></div>
    </div>
    
  </aside>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby3cb0GPBVrnnug-Obudwdr3Qayz1hEbhomS6A7GmUrSUSctjzsP0rawLr_I4QEKKOO/exec"; // Google Apps Script Web App URL (POST)
const TIME_LIMIT = 10 * 60; // 10 minutes in seconds

const QUESTIONS = [
  {q:"Riddle: The Sneaky Visitor\n\nI come into your house only when you open the door for me. I pretend to be someone you trust, but I'm not. What am I?",choices:["A delayed system update","A phishing email","A trusted program running in safe mode","An auto-generated login alert"],answer:1,explain:"A phishing email pretends to be trusted but is malicious."},
  {q:"Riddle: The Secret Keeper\n\nI protect your accounts like a lock on a treasure chest. But if you share me, I become useless. What am I?",choices:["A one-time verification code","A password","A browser autofill entry","A recovery backup phrase"],answer:1,explain:"Passwords protect your accounts and become useless if shared."},
  {q:"Riddle: The Disappearing Wallet\n\nI steal your money without touching your pocket. I trick you into typing your card details. What am I?",choices:["A cloned bank login page","A suspicious ATM skimmer","A misconfigured VPN session","A public Wi-Fi login portal"],answer:0,explain:"A cloned bank login page tricks you into giving card details."},
  {q:"Riddle: The Noisy Guardian\n\nI shout when something suspicious happens. I don’t stop attacks but warn you about them. What am I?",choices:["A threat-monitoring dashboard","A security log parser","An antivirus alert","A behavioral analytics engine"],answer:2,explain:"An antivirus alert warns about suspicious activity but doesn't stop attacks directly."},
  {q:"Riddle: The Spy in Your Hand\n\nI can see your location, photos, and messages. You trust me with everything. If I fall into the wrong hands, you're in danger. What am I?",choices:["Your smartphone","Your password manager","Your synced cloud drive","Your SIM card"],answer:0,explain:"Your smartphone holds most personal data and can be exploited if lost or stolen."},
  {q:"Riddle: The Masked File\n\nI look innocent like a picture or a song, but once you open me, I cause chaos. What am I?",choices:["A malicious executable disguised with a double extension","A compressed archive containing mixed media","A sandboxed application running silently","A temporary swap file from a background process"],answer:0,explain:"Malicious executables can hide as innocent-looking files and execute harmful actions."},
  {q:"Riddle: The Invisible Wall\n\nI stand between you and attackers. You don’t see me, but I block dangerous traffic. What am I?",choices:["A DNS sinkhole","A firewall","A default gateway’s ACL","A reverse proxy with rate-limits"],answer:1,explain:"A firewall blocks unauthorized traffic invisibly to users."},
  {q:"Riddle: The Fake Friend Request\n\nI look like a message from someone you know, but I’m created by a criminal. What am I?",choices:["A compromised contact syncing request","A redirected DNS resolver response","A social engineering attempt","A spoofed MFA denial notification"],answer:2,explain:"Social engineering attempts trick you into trusting a malicious source."},
  {q:"Riddle: The Door That Never Closes\n\nI stay open on your device unless you tell me to stop. Attackers love me because I let them walk right in. What am I?",choices:["An outdated Bluetooth pairing session","An unused but open network port","A disabled auto-lock screen","A misconfigured display driver"],answer:1,explain:"Open network ports can be exploited by attackers if left unattended."},
  {q:"Riddle: The Shadow That Follows You\n\nI track your behavior online and show you things you didn’t ask for. What am I?",choices:["A corrupted DNS cache","A tracking cookie","A proxy timeout","A VPN handshake leak"],answer:1,explain:"Tracking cookies monitor online behavior without explicit consent."},
  {q:"Riddle: The Pretend Protector\n\nI say I’ll keep you safe, but I’m actually the danger. I install myself when you search for “security tools.” What am I?",choices:["A rogue antivirus program","A browser incompatibility patch","A firmware integrity checker","A backup snapshot validator"],answer:0,explain:"A rogue antivirus program pretends to protect but is malware itself."},
  {q:"Riddle: The Hidden Guest\n\nYou don't know I'm here. I run quietly for months, watching everything you do. What am I?",choices:["A corrupted syslog rotation","A rootkit","A silent DHCP conflict","A misconfigured cron job"],answer:1,explain:"Rootkits operate silently and give attackers control of your system."},
  {q:"Riddle: The Locked Treasure Box\n\nI protect important information. You need two things to open me—your brain and your phone. What am I?",choices:["A secure notes vault","Two-factor authentication","A salted hash","A biometric certificate"],answer:1,explain:"Two-factor authentication requires something you know and something you have."},
  {q:"Riddle: The Loud but Useless Guard\n\nI shout warnings, sometimes too many, until people stop listening to me. What am I?",choices:["A vulnerability scanner in default mode","SIEM alert fatigue","Constant failed-logon logs","A firewall with geo-blocking"],answer:1,explain:"SIEM alert fatigue occurs when too many alerts desensitize staff to real threats."},
  {q:"Riddle: The Messenger of Malware\n\nI look like an ordinary storage device. When you plug me in, I deliver a surprise — and it’s not a good one. What am I?",choices:["A boot-sector-infected USB drive","A corrupted NTFS file table","A removable NVMe enclosure","A firmware-flashed SD card"],answer:0,explain:"Boot-sector-infected USB drives execute malware as soon as they are plugged in."}
];

let currentIndex=0,score=0,correct=0,wrong=0,selected=null,timerSeconds=TIME_LIMIT,timerInterval=null,total=QUESTIONS.length;

// --- State Management Functions ---

/**
 * Saves the current essential quiz state to sessionStorage.
 */
function saveState() {
    const state = {
        currentIndex: currentIndex,
        score: score,
        correct: correct,
        wrong: wrong,
        timerSeconds: timerSeconds,
        // We only save the index, the question state is loaded on render
    };
    sessionStorage.setItem('quizState', JSON.stringify(state));
}

/**
 * Loads the quiz state from sessionStorage if it exists.
 * @returns {boolean} True if state was loaded, false otherwise.
 */
function loadState() {
    const savedState = sessionStorage.getItem('quizState');
    if (savedState) {
        const state = JSON.parse(savedState);
        currentIndex = state.currentIndex;
        score = state.score;
        correct = state.correct;
        wrong = state.wrong;
        timerSeconds = state.timerSeconds;
        return true;
    }
    return false;
}

/**
 * Clears the quiz state from sessionStorage (used when quiz finishes).
 */
function clearState() {
    sessionStorage.removeItem('quizState');
}

// --- Quiz Logic ---
function init() {
  if (loadState()) {
      // If state loaded, we start the timer and render the current question
      console.log("State loaded. Resuming quiz.");
      document.getElementById('qTotal').textContent = total;
      renderQuestion(); 
      renderMap(); 
      startTimer();
  } else {
      // If no state loaded, start quiz fresh
      console.log("No state found. Starting new quiz.");
      QUESTIONS.sort(()=>0.5 - Math.random());
      document.getElementById('qTotal').textContent = total;
      resetState(); 
      renderQuestion(); 
      renderMap(); 
      startTimer();
  }
}

function resetState() {
  currentIndex=0; score=0; correct=0; wrong=0; selected=null;
  timerSeconds=TIME_LIMIT; // Reset timer for a fresh start
  document.getElementById('endBlock').style.display='none';
  document.getElementById('questionCard').style.display='block';
  clearState(); // Clear any residual state when starting fresh
}

function startTimer() {
  updateTimeDisplay();
  timerInterval=setInterval(()=>{
    timerSeconds--;
    if(timerSeconds<=0){ clearInterval(timerInterval); endQuiz(); return; }
    updateTimeDisplay(); 
    updateProgress();
    saveState(); // Save state every second to keep the timer updated
  },1000);
}

function updateTimeDisplay() {
  const mm=Math.floor(timerSeconds/60).toString().padStart(2,'0');
  const ss=(timerSeconds%60).toString().padStart(2,'0');
  document.getElementById('timeLeft').textContent=`${mm}:${ss}`;
}

function updateProgress() {
  const pct=((TIME_LIMIT - timerSeconds)/TIME_LIMIT)*100;
  document.getElementById('timeProgress').style.width=pct+'%';
}

function renderMap() {
  const map=document.getElementById('map'); map.innerHTML='';
  for(let i=0;i<total;i++){
    const b=document.createElement('div');
    b.textContent=i+1; b.style.width='34px'; b.style.height='34px'; b.style.borderRadius='8px';
    b.style.display='flex'; b.style.alignItems='center'; b.style.justifyContent='center';
    b.style.background='rgba(255,255,255,0.02)'; b.style.fontSize='13px'; b.style.cursor='pointer';
    b.dataset.idx=i; b.addEventListener('click',()=>{jumpTo(i);});
    map.appendChild(b);
  } highlightMap();
}

function highlightMap() {
  const map=document.getElementById('map').children;
  for(let i=0;i<map.length;i++){
    map[i].style.opacity=i===currentIndex?'1':'0.6';
    map[i].style.border=i===currentIndex?'2px solid rgba(0,180,216,0.18)':'none';
  }
}

function renderQuestion() {
  const qObj=QUESTIONS[currentIndex];
  document.getElementById('qText').textContent=qObj.q;
  const choices=document.getElementById('choices'); choices.innerHTML='';
  qObj.choices.forEach((c,i)=>{
    const div=document.createElement('div'); div.textContent=c; div.className='choice';
    div.addEventListener('click',()=>selectAnswer(i));
    choices.appendChild(div);
  });
  document.getElementById('qIndex').textContent=currentIndex+1;
  selected=null; highlightMap();
}

function selectAnswer(idx){
  if(selected!==null) return; 
  
  selected=idx; 
  const qObj=QUESTIONS[currentIndex];
  const choices=document.getElementById('choices').children;
  
  // 1. Update Score (Backend only)
  if(idx===qObj.answer){
    score+=10; 
    correct++;
  } else {
    wrong++;
  }
  
  // 2. Update Visuals
  for(let i=0;i<choices.length;i++){
    if(i===idx) {
        // Apply blue outline to the selected answer (correct or wrong)
        choices[i].classList.add('selected'); 
    }
    // Disable click events on all choices after selection
    choices[i].style.pointerEvents = 'none'; 
  }
  saveState(); // Save state immediately after an answer is selected
}

document.getElementById('nextBtn').addEventListener('click',()=>{
  if(selected===null) { 
    alert("Please select an answer before proceeding.");
    return;
  }
  currentIndex++;
  if(currentIndex>=total){ endQuiz(); return; }
  
  // Update state before rendering next question
  saveState(); 
  renderQuestion(); 
});

function jumpTo(idx){ 
    currentIndex=idx; 
    // No need to save state here, it will be saved on next answer/next click
    renderQuestion(); 
}

function endQuiz() {
  clearInterval(timerInterval);
  const timeUsed=TIME_LIMIT - timerSeconds;
  document.getElementById('questionCard').style.display='none';
  document.getElementById('endBlock').style.display='block';
  
  // Display only completion message, not the score
  document.getElementById('resultSummary').innerHTML=`
    <div style="font-size:18px;font-weight:800">Quiz Complete!</div>
    <div class="small" style="margin-top:6px">Thank you for participating. Your results have been recorded.</div>
    <div class="small">Time taken: ${Math.floor(timeUsed/60)}m ${timeUsed%60}s</div>
  `;
  sendResultsToSheet(score,timeUsed);
  clearState(); // Clear state because the quiz is finished
}

function sendResultsToSheet(score, timeTaken) {
  // Retrieve user data from sessionStorage
  const userData = sessionStorage.getItem('userData');
  
  if (!userData) {
    console.error("User data not found. Score will not be saved."); 
    return;
  }
  
  // Parse the stored data
  const { username, email, phone } = JSON.parse(userData);
  
  // Send all data to the sheet
  fetch(SCRIPT_URL, {
    method: 'POST',
    body: JSON.stringify({ 
      username: username,
      email: email,
      phone: phone,
      score: score, 
      timeTaken: timeTaken 
    })
  }).catch(err => console.error(err));
}
window.onload=init;
</script>
</body>
</html>
